
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://nightlanding.github.io/moli/CS61C/Labs/Lab_2/">
      
      
        <link rel="prev" href="../../Projects/Project_1/">
      
      
        <link rel="next" href="../Lab_3/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>实验 2 - MOLI：提升实践能力的试炼之地</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lab-2c" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="MOLI：提升实践能力的试炼之地" class="md-header__button md-logo" aria-label="MOLI：提升实践能力的试炼之地" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MOLI：提升实践能力的试炼之地
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              实验 2
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/nightlanding/moli" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    MOLI
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  首页

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../LearnPath/LearnPath/" class="md-tabs__link">
        
  
  
    
  
  学习路线

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../CS61A/CS61A/" class="md-tabs__link">
          
  
  
  CS61A

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../CS61B/CS61B/" class="md-tabs__link">
          
  
  
  CS61B

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../CS61C/" class="md-tabs__link">
          
  
  
  CS61C

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../PA/PA/" class="md-tabs__link">
        
  
  
    
  
  南京大学 ICS

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../MIT6.S081/MIT6.S081/" class="md-tabs__link">
        
  
  
    
  
  MIT6.S081

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../Contact/" class="md-tabs__link">
        
  
  
    
  
  联系我们

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../AboutMOLI/" class="md-tabs__link">
        
  
  
    
  
  关于 MOLI

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="MOLI：提升实践能力的试炼之地" class="md-nav__button md-logo" aria-label="MOLI：提升实践能力的试炼之地" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    MOLI：提升实践能力的试炼之地
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/nightlanding/moli" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    MOLI
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    首页
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../LearnPath/LearnPath/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    学习路线
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    CS61A
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            CS61A
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61A/CS61A/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    课程简介
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61A/Schedule/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    时间表
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    实验与作业
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            实验与作业
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_3_1" id="__nav_3_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    课程 1: 欢迎
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_1">
            <span class="md-nav__icon md-icon"></span>
            课程 1: 欢迎
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61A/labs/lab00/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验 00
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_3_2" id="__nav_3_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    课程 2: 函数
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_2">
            <span class="md-nav__icon md-icon"></span>
            课程 2: 函数
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61A/homeworks/homework01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    作业 01
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3_3" id="__nav_3_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    课程 3: 控制
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_3">
            <span class="md-nav__icon md-icon"></span>
            课程 3: 控制
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61A/labs/lab01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验 01
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_3_4" id="__nav_3_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    课程 4: 高阶函数
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_4">
            <span class="md-nav__icon md-icon"></span>
            课程 4: 高阶函数
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61A/projects/hog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    猪
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_3_5" id="__nav_3_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    课程 5: 环境
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_5">
            <span class="md-nav__icon md-icon"></span>
            课程 5: 环境
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61A/homeworks/homework02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    作业 02
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_6" >
        
          
          <label class="md-nav__link" for="__nav_3_3_6" id="__nav_3_3_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    课程 6: 函数抽象
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_6">
            <span class="md-nav__icon md-icon"></span>
            课程 6: 函数抽象
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61A/labs/lab02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验 02
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_7" >
        
          
          <label class="md-nav__link" for="__nav_3_3_7" id="__nav_3_3_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    课程 10: 递归、树形递归
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_7">
            <span class="md-nav__icon md-icon"></span>
            课程 10: 递归、树形递归
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61A/homeworks/homework03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    作业 03
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    讨论
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            讨论
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61A/discussions/disc00/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    讨论 00
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61A/discussions/disc01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    讨论 01
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61A/discussions/disc02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    讨论 02
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61A/discussions/disc03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    讨论 03
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    CS61B
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            CS61B
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61B/CS61B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    课程简介
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    实验
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            实验
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61B/labs/lab01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验 1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61B/labs/lab02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验 2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61B/labs/lab03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验 3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61B/labs/lab04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验 4
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    项目
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            项目
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61B/projects/proj0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Project 0
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61B/projects/proj1a/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Project 1A
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CS61B/projects/proj1b/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Project 1B
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    CS61C
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            CS61C
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CS61C/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    课程简介
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Schedule/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    时间表
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" checked>
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    实验
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            实验
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3_1" >
        
          
          <label class="md-nav__link" for="__nav_5_3_1" id="__nav_5_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    课程 2: 数值表示
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3_1">
            <span class="md-nav__icon md-icon"></span>
            课程 2: 数值表示
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Lab_0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验 0
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3_2" >
        
          
          <label class="md-nav__link" for="__nav_5_3_2" id="__nav_5_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    课程 4: C语言: 指针、数组、字符串
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3_2">
            <span class="md-nav__icon md-icon"></span>
            课程 4: C语言: 指针、数组、字符串
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Lab_1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验 1
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3_3" id="__nav_5_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    课程 6: C语言: 泛型
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3_3">
            <span class="md-nav__icon md-icon"></span>
            课程 6: C语言: 泛型
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Projects/Project_1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    项目 1
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3_4" checked>
        
          
          <label class="md-nav__link" for="__nav_5_3_4" id="__nav_5_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    课程 7: 浮点运算
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_3_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_3_4">
            <span class="md-nav__icon md-icon"></span>
            课程 7: 浮点运算
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    实验 2
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    实验 2
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      环境准备
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      练习 1：编译器警告和错误
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gdb" class="md-nav__link">
    <span class="md-ellipsis">
      什么是 GDB？
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2gdb" class="md-nav__link">
    <span class="md-ellipsis">
      练习 2：GDB 入门
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-gdb" class="md-nav__link">
    <span class="md-ellipsis">
      练习 3：更多 GDB
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      练习 4：调试
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5segfault" class="md-nav__link">
    <span class="md-ellipsis">
      练习 5：调试段错误（Segfault）
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#valgrind" class="md-nav__link">
    <span class="md-ellipsis">
      Valgrind
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercise-6-valgrind" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 6: 使用 Valgrind 查找段错误
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercise-7" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 7: 内存管理
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercise-8" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 8: 调试内存泄漏
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercise-9" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 9: 反馈与调查问卷
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      提交
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gdb_1" class="md-nav__link">
    <span class="md-ellipsis">
      常见的 GDB 错误
    </span>
  </a>
  
    <nav class="md-nav" aria-label="常见的 GDB 错误">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gdb_2" class="md-nav__link">
    <span class="md-ellipsis">
      GDB 跳过代码行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gdb_3" class="md-nav__link">
    <span class="md-ellipsis">
      GDB 无法加载文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      如何在代码窗口和控制台之间切换？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      我卡在代码窗口里了
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ui" class="md-nav__link">
    <span class="md-ellipsis">
      文本 UI 显示混乱
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gdb_4" class="md-nav__link">
    <span class="md-ellipsis">
      其他有用的 GDB 命令（推荐）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="其他有用的 GDB 命令（推荐）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#info-locals" class="md-nav__link">
    <span class="md-ellipsis">
      命令：info locals
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#commands" class="md-nav__link">
    <span class="md-ellipsis">
      命令：commands
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3_5" >
        
          
          <label class="md-nav__link" for="__nav_5_3_5" id="__nav_5_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    课程 10: RISC-V: 条件分支
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3_5">
            <span class="md-nav__icon md-icon"></span>
            课程 10: RISC-V: 条件分支
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Lab_3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    实验 3
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    讨论
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            讨论
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4_1" >
        
          
          <label class="md-nav__link" for="__nav_5_4_1" id="__nav_5_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    讨论 1
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_1">
            <span class="md-nav__icon md-icon"></span>
            讨论 1
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Discussion/Discussion_1_pre/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    预习
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Discussion/Discussion_1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    作业
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PA/PA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    南京大学 ICS
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../MIT6.S081/MIT6.S081/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MIT6.S081
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Contact/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    联系我们
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../AboutMOLI/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    关于 MOLI
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="lab-2c">Lab 2：C 语言调试<a class="headerlink" href="#lab-2c" title="Permanent link">&para;</a></h1>
<div class="admonition info">
<p class="admonition-title">MOLI：本次实验你将会学到什么</p>
<ul>
<li>GDB 基础操作  </li>
<li>Valgrind 基础操作 </li>
<li>调试段错误、内存泄漏</li>
</ul>
</div>
<p>在本次实验中，请按照列出的顺序完成各个练习。练习之间可能互相依赖。</p>
<p><a href="https://docs.google.com/presentation/d/1rJ81qVQORpyaox744ocJ66UrQPZl6FvrNl1giFQWJHk/edit?usp=sharing">实验幻灯片（Berkeley校内）</a></p>
<hr />
<h2 id="_1">环境准备<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>你必须在 hive 机器上完成本次实验。有关使用 hive 机器的复习，请参见 <a href="https://cs61c.org/sp25/labs/lab00/">Lab 0</a>。</p>
<p>在你的 <code>labs</code> 目录中，使用以下命令拉取本次实验的文件：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>pull<span class="w"> </span>starter<span class="w"> </span>main
</code></pre></div>
<p>如果你遇到如下错误：</p>
<div class="highlight"><pre><span></span><code>fatal: &#39;starter&#39; does not appear to be a git repository
fatal: Could not read from remote repository.
</code></pre></div>
<p>请确保将 starter 远程仓库设置为：</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>remote<span class="w"> </span>add<span class="w"> </span>starter<span class="w"> </span>https://github.com/61c-teach/sp25-lab-starter.git
</code></pre></div>
<p>然后再次运行上面的命令。</p>
<p>如果遇到任何 <code>git</code> 错误，请查看 <a href="https://cs61c.org/sp25/resources/common-errors/">常见错误</a> 页面。</p>
<hr />
<h2 id="1">练习 1：编译器警告和错误<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<p>编译器警告用于帮助你发现代码中的潜在错误。在运行代码之前，请确保修复所有编译器警告。这将节省你大量调试时间，因为修复编译器警告通常比手动查找错误快得多。</p>
<ol>
<li><strong>阅读</strong> <code>ex1_compiler_warnings.c</code> 中的代码。</li>
<li>使用 <code>gcc -o ex1_compiler_warnings ex1_compiler_warnings.c</code> 编译程序。你应该会看到 3 条警告。</li>
<li><strong>阅读</strong> 第一条警告的第一行。该行以 <code>ex1_compiler_warnings.c:13:22</code> 开头，告诉你警告在第 13 行第 22 列。警告指出程序试图将一个 <code>char</code> 赋值给 <code>char *</code>。</li>
<li><strong>打开</strong> <code>ex1_compiler_warnings.c</code> 并定位到导致警告的那一行。该行试图将 <code>char</code> 赋值给 <code>char *</code>。编译器指出这是一个潜在错误，因为不应该将 <code>char</code> 赋给 <code>char *</code>。</li>
<li><strong>修复</strong> 此编译器警告。</li>
<li><strong>重新编译</strong> 你的代码。你会发现该警告消失，剩余 2 条警告。</li>
<li><strong>修复</strong> <code>ex1_compiler_warnings.c</code> 中剩余的警告。此时你的代码应能正常工作。</li>
</ol>
<h2 id="gdb">什么是 GDB？<a class="headerlink" href="#gdb" title="Permanent link">&para;</a></h2>
<p>以下内容摘自 <a href="https://www.gnu.org/software/gdb/">GDB 官方网站</a>：</p>
<p>GDB（GNU 项目调试器）允许你在程序执行时或程序崩溃时，查看程序内部的运行情况。</p>
<p>GDB 可以做以下四类主要操作（以及其它辅助功能），帮助你捕捉 bug：</p>
<ul>
<li>启动你的程序，并指定可能影响其行为的参数。</li>
<li>在满足指定条件时，让程序暂停执行。</li>
<li>在程序暂停时，检查程序状态。</li>
<li>修改程序中的内容，以便你可以尝试修复一个 bug 并继续调试下一个。</li>
</ul>
<p>在本课程中，我们将使用 <a href="https://cgdb.github.io/">CGDB</a>，它提供了一个轻量级界面来简化 gdb 的使用。CGDB 已经安装在 hive 机器上，因此无需安装。以下内容中，CGDB 和 GDB 将交替使用。</p>
<p>这是一个 <a href="https://inst.eecs.berkeley.edu/~cs61c/resources/gdb5-refcard.pdf">GDB 参考卡</a>。</p>
<p>如果使用 GDB 时遇到任何问题，请参见下文的 <a href="https://cs61c.org/sp25/labs/lab02/#common-gdb-errors">常见 GDB 错误</a> 部分。```</p>
<h2 id="2gdb">练习 2：GDB 入门<a class="headerlink" href="#2gdb" title="Permanent link">&para;</a></h2>
<p>在本部分中，你将学习 GDB 命令 <code>start</code>、<code>step</code>、<code>next</code>、<code>finish</code>、<code>print</code> 和 <code>quit</code>。本节将在过程中解决一个或多个 bug。在继续之前，请确保修复代码中的 bug。</p>
<p>下表总结了上述命令：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>缩写</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>start</td>
<td>start</td>
<td>开始运行程序并在 <code>main</code> 的第 1 行暂停</td>
</tr>
<tr>
<td>step</td>
<td>s</td>
<td>执行当前行代码（会进入函数内部）</td>
</tr>
<tr>
<td>next</td>
<td>n</td>
<td>执行当前行代码（不会进入函数内部）</td>
</tr>
<tr>
<td>finish</td>
<td>fin</td>
<td>执行当前函数剩余部分，并返回到调用函数</td>
</tr>
<tr>
<td>print [参数]（例如：<code>int n=3</code> 时，<code>print n</code> 会输出 3）</td>
<td>p</td>
<td>打印参数的值</td>
</tr>
<tr>
<td>quit</td>
<td>q</td>
<td>退出 GDB</td>
</tr>
</tbody>
</table>
<p>你需要在 <code>ex2_commands.txt</code> 中填写对应的命令。请仅使用上表中的命令。<strong>为保证正确性，我们将把你的 <code>ex2_commands.txt</code> 输出与预期输出进行比对。</strong> 建议打开两个 SSH 窗口，一个查看 <code>ex2_commands.txt</code>，一个运行 <code>cgdb</code> 会话。虽然你在编辑 <code>ex2_commands.txt</code>，但请务必在 <code>cgdb</code> 中实际运行这些命令来检查结果。</p>
<ol>
<li><strong>使用 <code>-g</code> 标志编译</strong> 程序，以包含调试信息：</li>
</ol>
<div class="highlight"><pre><span></span><code>gcc<span class="w"> </span>-g<span class="w"> </span>-o<span class="w"> </span>pwd_checker<span class="w"> </span>test_pwd_checker.c<span class="w"> </span>pwd_checker.c
</code></pre></div>
<ol>
<li><strong>启动</strong> <code>cgdb</code>（注意参数是可执行文件 <code>pwd_checker</code>，而不是源文件）：</li>
</ol>
<div class="highlight"><pre><span></span><code>cgdb<span class="w"> </span>pwd_checker
</code></pre></div>
<p>你现在应该能看到 CGDB 界面，上方窗口显示代码，下方窗口显示控制台。</p>
<p>对于以下每一步，将在 <code>ex2_commands.txt</code> 中添加你执行的 CGDB 命令。每条命令单独占一行。下面每一步可能需要一个或多个 CGDB 命令。</p>
<ol>
<li><strong>使用一个命令</strong> 启动程序，并让它暂停在 <code>main</code> 的第一行。</li>
<li>第一行是对 <code>printf</code> 的调用，我们不想进入该函数。<strong>跳过（step over）</strong> 这行代码。</li>
<li><strong>执行到（step until）</strong> 程序停在 <code>check_password</code> 调用处。注意带箭头的一行是当前行，但尚未执行。</li>
<li><strong>进入（step into）</strong> <code>check_password</code>。</li>
<li><strong>进入（step into）</strong> <code>check_lower</code>。</li>
<li><strong>打印（print）</strong> <code>password</code> 的值（<code>password</code> 是一个字符串）。</li>
<li><strong>立即跳出（step out）</strong> <code>check_lower</code>，不要等到函数自然返回。</li>
<li><strong>进入（step into）</strong> <code>check_length</code>。</li>
<li><strong>执行到（step to）</strong> 函数的最后一行。</li>
<li><strong>打印（print）</strong> 函数的返回值，应该是 <code>false</code>。</li>
<li><strong>打印（print）</strong> <code>length</code> 的值。看起来 <code>length</code> 是正确的，所以第 24 行逻辑应该有问题。</li>
<li><strong>退出（quit）</strong> CGDB。CGDB 可能会询问是否退出，输入 <code>y</code>（但不要将 <code>y</code> 写入 <code>ex2_commands.txt</code>）。</li>
</ol>
<p>此时，<code>ex2_commands.txt</code> 应包含上述命令列表。接下来的步骤不需添加到 <code>ex2_commands.txt</code>：</p>
<ol>
<li><strong>修复</strong> 第 24 行的 bug。</li>
<li><strong>编译</strong> 并 <strong>运行</strong> 代码。</li>
<li>程序仍然失败。重新在 <code>cgdb</code> 中单步调试，应能看到 <code>check_number</code> 现在出错。下一练习将处理该问题。</li>
</ol>
<hr />
<h2 id="3-gdb">练习 3：更多 GDB<a class="headerlink" href="#3-gdb" title="Permanent link">&para;</a></h2>
<p>在本部分中，你将学习 GDB 命令 <code>break</code>、条件断点（conditional break）、<code>run</code> 和 <code>continue</code>。本节将在过程中解决一个或多个 bug。在继续之前，请确保修复代码中的 bug。</p>
<p>下表总结了上述命令：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>缩写</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>break [行号或函数名]</td>
<td>b</td>
<td>在指定位置设置断点；使用 <code>filename.c:linenum</code> 可在特定文件的某行设置断点</td>
</tr>
<tr>
<td>条件断点（示例：<code>break 3 if n==4</code>）</td>
<td>b 3 if n==4</td>
<td>只有在指定条件满足时才在该位置触发断点</td>
</tr>
<tr>
<td>run</td>
<td>r</td>
<td>执行程序，直到结束或遇到断点</td>
</tr>
<tr>
<td>continue</td>
<td>c</td>
<td>继续执行已暂停的程序</td>
</tr>
<tr>
<td>backtrace</td>
<td>bt</td>
<td>打印调用栈中各帧（每帧一行）</td>
</tr>
</tbody>
</table>
<p>你需要在 <code>ex3_commands.txt</code> 中填写对应的命令。请仅使用本表及练习 2 表中的命令。<strong>为保证正确性，我们将把你的 <code>ex3_commands.txt</code> 输出与预期输出进行比对。</strong> 同样建议两个 SSH 窗口，一个编辑命令文件，一个运行 CGDB。</p>
<ol>
<li><strong>重新编译并运行</strong> 代码，你会看到断言 <code>number</code> 失败。</li>
<li><strong>启动</strong> CGDB：</li>
</ol>
<div class="highlight"><pre><span></span><code>cgdb<span class="w"> </span>pwd_checker
</code></pre></div>
<p>对于以下每一步，将在 <code>ex3_commands.txt</code> 中添加你执行的 CGDB 命令。每条命令单独占一行。</p>
<ol>
<li><strong>设置断点（break）</strong> 到 <code>check_number</code> 函数（使用函数名，不要指定文件或行号）。断点应在 <code>check_password</code> 之外。</li>
<li><strong>运行（run）</strong> 程序，直到命中刚才的断点。</li>
<li><strong>进入（step into）</strong> <code>check_range</code>。</li>
<li><strong>查看调用栈（backtrace）</strong>。</li>
<li>因为密码中数字是在后面才出现的，我们可以使用条件断点跳过前面的非数字字符。第一个数字是 <code>0</code>，所以设置条件断点：<strong>当 <code>letter == '0'</code> 时在第 31 行断点</strong>。</li>
<li><strong>继续（continue）</strong> 程序执行，直到断点。</li>
<li>断点命中后，<strong>打印（print）</strong> <code>letter</code>，应显示 <code>48 '0'</code>。</li>
<li><strong>打印（print）</strong> <code>is_in_range</code>，结果是 <code>false</code>，但 <code>'0'</code> 应该在范围内。</li>
<li><strong>打印（print）</strong> <code>lower</code>。</li>
<li><strong>打印（print）</strong> <code>upper</code>。</li>
<li>你会发现 <code>lower</code> 的 ASCII 是 <code>\000</code>（空字符），<code>upper</code> 的 ASCII 是 <code>\t</code>（制表符），说明传入的是数字 <code>0</code> 和 <code>9</code> 而非字符 <code>'0'</code> 和 <code>'9'</code>。</li>
<li><strong>退出（quit）</strong> CGDB。输入 <code>y</code>（但不要将 <code>y</code> 写入 <code>ex3_commands.txt</code>）。</li>
</ol>
<p>此时，<code>ex3_commands.txt</code> 应包含上述命令列表。接下来的步骤不需添加到 <code>ex3_commands.txt</code>：</p>
<ol>
<li><strong>修复</strong> 该 bug。</li>
<li><strong>编译</strong> 并 <strong>运行</strong> 代码。还有一个错误，将在 <a href="https://cs61c.org/sp25/labs/lab02/#exercise-4-debug">练习 4：调试</a> 中发现并解决。</li>
</ol>
<h2 id="4">练习 4：调试<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<p>本练习为 <strong>可选</strong>。但是，使用 CGDB 进行调试对于项目 1 及以后的工作非常重要，因此我们强烈建议你练习以积累经验。</p>
<ol>
<li><strong>使用</strong> 你刚学到的命令自行调试 <code>check_upper</code>。该函数似乎在有大写字母时仍然返回 <code>false</code>。提示：bug 本身可能不在 <code>check_upper</code> 函数内部。</li>
<li><strong>修复</strong> 该 bug。</li>
</ol>
<h2 id="5segfault">练习 5：调试段错误（Segfault）<a class="headerlink" href="#5segfault" title="Permanent link">&para;</a></h2>
<p>GDB 的一个非常重要的功能是调试段错误。本练习在不使用这些 GDB 工具的情况下也是可以完成的，但习惯使用它们对于后续实验和项目 1 都非常有帮助。请尽量按照说明，在不查看源代码的情况下，使用 GDB 终端找出答案。</p>
<p>在本练习中，你需要填写 <code>ex5_answers.txt</code>。</p>
<ol>
<li><strong>编译</strong> <code>ex5_segfault.c</code>。注意没有编译错误或警告，并且我们使用了 <code>-g</code> 标志，以便将来需要调试时使用。</li>
</ol>
<div class="highlight"><pre><span></span><code>gcc<span class="w"> </span>-g<span class="w"> </span>-o<span class="w"> </span>ex5_segfault<span class="w"> </span>ex5_segfault.c
</code></pre></div>
<ol>
<li><strong>运行</strong> <code>ex5_segfault</code>。程序应当因段错误而崩溃。</li>
<li><strong>使用</strong> <code>cgdb</code> 运行 <code>ex5_segfault</code>，并执行到段错误发生时，然后显示程序的 <code>backtrace</code>。</li>
<li>
<p><strong>仔细阅读</strong> 输出，并在 <code>ex5_answers.txt</code> 中回答以下问题。请不要更改文件格式。</p>
</li>
<li>
<p>段错误发生在哪个函数中？（答案应为函数名）</p>
</li>
<li>哪一行代码导致了段错误？（答案应为单个数字，不带任何单位）</li>
</ol>
<h2 id="valgrind">Valgrind<a class="headerlink" href="#valgrind" title="Permanent link">&para;</a></h2>
<p>即使使用调试器，我们也可能无法捕捉所有的 bug。有些 bug 我们称为 “bohrbugs”，它们会在一组定义良好但可能未知的条件下可靠地重现。另一些 bug 我们称为 “heisenbugs”，它们并不是确定性的，研究它们时往往会消失或改变行为。我们可以使用调试器检测第一类 bug，但第二类 bug（尤其在 C 语言中）通常由于内存管理不当而难以察觉。请记住，与其他编程语言不同，C 语言要求程序员手动管理内存。</p>
<p>我们可以使用一个名为 Valgrind 的工具来帮助捕捉这两类 bug。Valgrind 是一个模拟 CPU 并跟踪内存访问的程序。它会减慢被运行程序的速度（这也是为什么我们不会总是在 Valgrind 中运行所有可执行文件），但也能揭示仅在特定情况下才会显现的 bug。</p>
<p>让我们来看看 <code>bork</code> 翻译程序！Bork 是一种非常类似英语的古老语言。要将一个单词翻译成 Bork，只需在单词的每个元音后面添加一个 <code>f</code>。</p>
<p>我们先编译并运行 <code>bork</code>，试试看输出：</p>
<div class="highlight"><pre><span></span><code>gcc<span class="w"> </span>-g<span class="w"> </span>-o<span class="w"> </span>bork<span class="w"> </span>bork.c
./bork<span class="w"> </span>hello
</code></pre></div>
<p>下面给出了一个示例输出。注意，你的输出可能有所不同。</p>
<div class="highlight"><pre><span></span><code>Input string: &quot;hello&quot;
Length of translated string: 21
Translate to Bork: &quot;hefl2?^?Ul2?^?Uof?^?U&quot;
</code></pre></div>
<p>嗯，Bork 是一种古老的语言，但不应该出现这些奇怪字符。看来古人程序里藏着一些 bug！我们要不要开始消灭这些 bug，揭开 Bork 真正的魅力？</p>
<p>快速浏览 <code>main</code>，可以看到我们将输入字符串（<code>src_str</code>）翻译成 Bork 字符串（<code>dest_str</code>）。向上滚动到文件顶部，可以看到：有一个 <code>alloc_str</code> 函数用于在堆上分配字符串空间；一个包含字符串及其长度的 <code>Str</code> 结构体；一个创建并初始化该结构体的 <code>make_str</code> 函数；以及一个释放结构体数据的函数。还有一个连接两个字符串的函数和一个将单个字符翻译为 Bork 的函数。这个程序相当长，调试起来比较繁琐。</p>
<p>有没有一种工具能给我们一个很好的起点？</p>
<p>事实证明，有好几种，而 <code>valgrind</code> 就是其中之一！</p>
<p>下面我们用 <code>valgrind</code> 运行程序，看看它会报告什么：</p>
<div class="highlight"><pre><span></span><code>valgrind<span class="w"> </span>./bork<span class="w"> </span><span class="nv">hello</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w"> </span>Memcheck,<span class="w"> </span>a<span class="w"> </span>memory<span class="w"> </span>error<span class="w"> </span><span class="nv">detector</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w"> </span>Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2002</span>-2017,<span class="w"> </span>and<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="s1">&#39;d, by Julian Seward et al.</span>
<span class="s1">==10170== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info</span>
<span class="s1">==10170== Command: ./bork hello</span>
<span class="s1">==10170==</span>
<span class="s1">==10170== Invalid read of size 1</span>
<span class="s1">==10170==    at 0x4C34D04: strlen (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)</span>
<span class="s1">==10170==    by 0x10879F: make_Str (bork.c:22)</span>
<span class="s1">==10170==    by 0x108978: translate_to_bork (bork.c:56)</span>
<span class="s1">==10170==    by 0x1089F2: main (bork.c:68)</span>
<span class="s1">==10170==  Address 0x522f041 is 0 bytes after a block of size 1 alloc&#39;</span><span class="nv">d</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>at<span class="w"> </span>0x4C31B0F:<span class="w"> </span>malloc<span class="w"> </span><span class="o">(</span><span class="k">in</span><span class="w"> </span>/usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so<span class="o">)</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x108781:<span class="w"> </span>alloc_str<span class="w"> </span><span class="o">(</span>bork.c:10<span class="o">)</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x10895E:<span class="w"> </span>translate_to_bork<span class="w"> </span><span class="o">(</span>bork.c:54<span class="o">)</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x1089F2:<span class="w"> </span>main<span class="w"> </span><span class="o">(</span>bork.c:68<span class="o">)</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w"> </span>Invalid<span class="w"> </span><span class="nb">read</span><span class="w"> </span>of<span class="w"> </span>size<span class="w"> </span><span class="nv">1</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>at<span class="w"> </span>0x4C34D04:<span class="w"> </span>strlen<span class="w"> </span><span class="o">(</span><span class="k">in</span><span class="w"> </span>/usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so<span class="o">)</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x10879F:<span class="w"> </span>make_Str<span class="w"> </span><span class="o">(</span>bork.c:22<span class="o">)</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x108952:<span class="w"> </span>translate_to_bork<span class="w"> </span><span class="o">(</span>bork.c:51<span class="o">)</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x1089F2:<span class="w"> </span>main<span class="w"> </span><span class="o">(</span>bork.c:68<span class="o">)</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">  </span>Address<span class="w"> </span>0x522f0e2<span class="w"> </span>is<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span>after<span class="w"> </span>a<span class="w"> </span>block<span class="w"> </span>of<span class="w"> </span>size<span class="w"> </span><span class="m">2</span><span class="w"> </span>alloc<span class="s1">&#39;d</span>
<span class="s1">==10170==    at 0x4C31B0F: malloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)</span>
<span class="s1">==10170==    by 0x108781: alloc_str (bork.c:10)</span>
<span class="s1">==10170==    by 0x10892D: translate_to_bork (bork.c:48)</span>
<span class="s1">==10170==    by 0x1089F2: main (bork.c:68)</span>
<span class="s1">==10170==</span>
<span class="s1">==10170== Invalid read of size 1</span>
<span class="s1">==10170==    at 0x4C34D04: strlen (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)</span>
<span class="s1">==10170==    by 0x4E9B4A2: vfprintf (vfprintf.c:1643)</span>
<span class="s1">==10170==    by 0x4EA2EE5: printf (printf.c:33)</span>
<span class="s1">==10170==    by 0x108A6F: main (bork.c:74)</span>
<span class="s1">==10170==  Address 0x522f317 is 0 bytes after a block of size 7 alloc&#39;</span><span class="nv">d</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>at<span class="w"> </span>0x4C31B0F:<span class="w"> </span>malloc<span class="w"> </span><span class="o">(</span><span class="k">in</span><span class="w"> </span>/usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so<span class="o">)</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x108781:<span class="w"> </span>alloc_str<span class="w"> </span><span class="o">(</span>bork.c:10<span class="o">)</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x108833:<span class="w"> </span>concat<span class="w"> </span><span class="o">(</span>bork.c:32<span class="o">)</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x108A15:<span class="w"> </span>main<span class="w"> </span><span class="o">(</span>bork.c:69<span class="o">)</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span>
Input<span class="w"> </span>string:<span class="w"> </span><span class="s2">&quot;hello&quot;</span>
Length<span class="w"> </span>of<span class="w"> </span>translated<span class="w"> </span>string:<span class="w"> </span><span class="nv">7</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w"> </span>Invalid<span class="w"> </span><span class="nb">read</span><span class="w"> </span>of<span class="w"> </span>size<span class="w"> </span><span class="nv">1</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>at<span class="w"> </span>0x4C34D04:<span class="w"> </span>strlen<span class="w"> </span><span class="o">(</span><span class="k">in</span><span class="w"> </span>/usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so<span class="o">)</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x4E9B4A2:<span class="w"> </span>vfprintf<span class="w"> </span><span class="o">(</span>vfprintf.c:1643<span class="o">)</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x4EA2EE5:<span class="w"> </span><span class="nb">printf</span><span class="w"> </span><span class="o">(</span>printf.c:33<span class="o">)</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x108A6F:<span class="w"> </span>main<span class="w"> </span><span class="o">(</span>bork.c:74<span class="o">)</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">  </span>Address<span class="w"> </span>0x522f317<span class="w"> </span>is<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span>after<span class="w"> </span>a<span class="w"> </span>block<span class="w"> </span>of<span class="w"> </span>size<span class="w"> </span><span class="m">7</span><span class="w"> </span>alloc<span class="err">&#39;</span><span class="nv">d</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>at<span class="w"> </span>0x4C31B0F:<span class="w"> </span>malloc<span class="w"> </span><span class="o">(</span><span class="k">in</span><span class="w"> </span>/usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so<span class="o">)</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x108781:<span class="w"> </span>alloc_str<span class="w"> </span><span class="o">(</span>bork.c:10<span class="o">)</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x108833:<span class="w"> </span>concat<span class="w"> </span><span class="o">(</span>bork.c:32<span class="o">)</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x108A15:<span class="w"> </span>main<span class="w"> </span><span class="o">(</span>bork.c:69<span class="o">)</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w"> </span>HEAP<span class="w"> </span>SUMMARY:
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">     </span><span class="k">in</span><span class="w"> </span>use<span class="w"> </span>at<span class="w"> </span>exit:<span class="w"> </span><span class="m">7</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">   </span>total<span class="w"> </span>heap<span class="w"> </span>usage:<span class="w"> </span><span class="m">11</span><span class="w"> </span>allocs,<span class="w"> </span><span class="m">10</span><span class="w"> </span>frees,<span class="w"> </span><span class="m">1</span>,051<span class="w"> </span>bytes<span class="w"> </span><span class="nv">allocated</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w"> </span>LEAK<span class="w"> </span>SUMMARY:
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>definitely<span class="w"> </span>lost:<span class="w"> </span><span class="m">7</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>indirectly<span class="w"> </span>lost:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">      </span>possibly<span class="w"> </span>lost:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">    </span>still<span class="w"> </span>reachable:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w">         </span>suppressed:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w"> </span>Rerun<span class="w"> </span>with<span class="w"> </span>--leak-check<span class="o">=</span>full<span class="w"> </span>to<span class="w"> </span>see<span class="w"> </span>details<span class="w"> </span>of<span class="w"> </span>leaked<span class="w"> </span><span class="nv">memory</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span>
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w"> </span>For<span class="w"> </span>counts<span class="w"> </span>of<span class="w"> </span>detected<span class="w"> </span>and<span class="w"> </span>suppressed<span class="w"> </span>errors,<span class="w"> </span>rerun<span class="w"> </span>with:<span class="w"> </span>-v
<span class="o">==</span><span class="nv">10170</span><span class="o">==</span><span class="w"> </span>ERROR<span class="w"> </span>SUMMARY:<span class="w"> </span><span class="m">6</span><span class="w"> </span>errors<span class="w"> </span>from<span class="w"> </span><span class="m">3</span><span class="w"> </span>contexts<span class="w"> </span><span class="o">(</span>suppressed:<span class="w"> </span><span class="m">0</span><span class="w"> </span>from<span class="w"> </span><span class="m">0</span><span class="o">)</span>
</code></pre></div>
<p>（有趣的旁注：当我们查看 <code>valgrind</code> 日志中的正常程序输出时，会发现它打印了 "hefllof"。这是因为 <code>valgrind</code> 运行程序的方式与程序“裸机”运行的方式不同。我们暂不深入讨论。）  </p>
<p>回到调试：在分析大型错误日志时，一个很好的经验法则是只关注第一条错误信息（忽略其余），我们就这样做：</p>
<div class="highlight"><pre><span></span><code>==10170== Invalid read of size 1
==10170==    at 0x4C34D04: strlen (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==10170==    by 0x10879F: make_Str (bork.c:22)
==10170==    by 0x108978: translate_to_bork (bork.c:56)
==10170==    by 0x1089F2: main (bork.c:68)
</code></pre></div>
<p>错误信息指出我们进行了大小为 1 的无效读取。这是什么意思？“无效读取”表示程序在不该读取的内存地址读取数据（这可能导致段错误，但并不总是）。“大小为 1”即尝试读取 1 字节。</p>
<p>由于我们不熟悉这个古老的代码库，也不想通读全部代码来找 bug，一个不错的做法是从高层次的细节开始，然后逐步深入（也就是按照 valgrind 提供的调用栈来排查）。</p>
<p>让我们查看 <code>bork.c</code> 第 68 行的 <code>main</code>（调用栈的底部）：</p>
<div class="highlight"><pre><span></span><code><span class="n">Str</span><span class="w"> </span><span class="n">bork_substr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">translate_to_bork</span><span class="p">(</span><span class="n">src_str</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</code></pre></div>
<p>这里有什么异常吗？看起来只是将一个字符传给 <code>translate_to_bork</code>，暂时没问题。</p>
<p>继续深入调用栈，查看 <code>translate_to_bork</code> 的第 56 行：</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span><span class="w"> </span><span class="n">make_Str</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
</code></pre></div>
<p>这里只是调用 <code>make_Str</code>，我们再往下看，查看 <code>bork.c</code> 第 22 行：</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">Str</span><span class="p">){.</span><span class="n">data</span><span class="o">=</span><span class="n">str</span><span class="p">,.</span><span class="n">len</span><span class="o">=</span><span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">)};</span>
</code></pre></div>
<p>在这里我们创建了一个新的 <code>Str</code> 结构体，并设置其 <code>data</code> 和 <code>len</code> 字段，看起来也没问题！</p>
<p>但 valgrind 却说 <code>strlen</code> 发生了无效读取？</p>
<p>我们确实是传递了一个字符串，strlen 会通过遍历字符直到遇到空终止符来计算长度。可能我们忘了加空终止符，strlen 就会越界读取超出分配范围的内存。</p>
<p>要确认，我们回到 <code>translate_to_bork</code> 的第 56 行：</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span><span class="w"> </span><span class="n">make_Str</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
</code></pre></div>
<p>向上两行（第 54 行）我们看到是在调用 <code>alloc_str</code> 来分配空间。来看这个函数：</p>
<div class="highlight"><pre><span></span><code><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">alloc_str</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">len</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p>这里 <code>alloc_str</code> 只分配了 <code>len</code> 个字节，没有为空终止符 <code>'\0'</code> 留空间！因此写入时无法添加终止符。</p>
<p>我们做如下修改来修复问题：</p>
<div class="highlight"><pre><span></span><code>10c10,12
<span class="gd">&lt;     return malloc(len*sizeof(char));</span>
<span class="gs">---</span>
<span class="gi">&gt;     char *data = malloc((len+1)*sizeof(char));</span>
<span class="gi">&gt;     data[len] = &#39;\0&#39;;</span>
<span class="gi">&gt;     return data;</span>
</code></pre></div>
<p>然后重新运行程序验证修复：</p>
<div class="highlight"><pre><span></span><code>./bork<span class="w"> </span>hello
Input<span class="w"> </span>string:<span class="w"> </span><span class="s2">&quot;hello&quot;</span>
Length<span class="w"> </span>of<span class="w"> </span>translated<span class="w"> </span>string:<span class="w"> </span><span class="m">7</span>
Translate<span class="w"> </span>to<span class="w"> </span>Bork:<span class="w"> </span><span class="s2">&quot;hefllof&quot;</span>
</code></pre></div>
<p>看起来一切正常了。但可能还有隐藏错误，我们再用 valgrind 检查：</p>
<div class="highlight"><pre><span></span><code>valgrind<span class="w"> </span>./bork<span class="w"> </span><span class="nv">hello</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w"> </span>Memcheck,<span class="w"> </span>a<span class="w"> </span>memory<span class="w"> </span>error<span class="w"> </span><span class="nv">detector</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w"> </span>Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2002</span>-2017,<span class="w"> </span>and<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="err">&#39;</span>d,<span class="w"> </span>by<span class="w"> </span>Julian<span class="w"> </span>Seward<span class="w"> </span>et<span class="w"> </span>al.
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w"> </span>Using<span class="w"> </span>Valgrind-3.13.0<span class="w"> </span>and<span class="w"> </span>LibVEX<span class="p">;</span><span class="w"> </span>rerun<span class="w"> </span>with<span class="w"> </span>-h<span class="w"> </span><span class="k">for</span><span class="w"> </span>copyright<span class="w"> </span><span class="nv">info</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w"> </span>Command:<span class="w"> </span>./bork<span class="w"> </span><span class="nv">hello</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span>
Input<span class="w"> </span>string:<span class="w"> </span><span class="s2">&quot;hello&quot;</span>
Length<span class="w"> </span>of<span class="w"> </span>translated<span class="w"> </span>string:<span class="w"> </span><span class="m">7</span>
Translate<span class="w"> </span>to<span class="w"> </span>Bork:<span class="w"> </span><span class="s2">&quot;hefllof&quot;</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w"> </span>HEAP<span class="w"> </span>SUMMARY:
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w">     </span><span class="k">in</span><span class="w"> </span>use<span class="w"> </span>at<span class="w"> </span>exit:<span class="w"> </span><span class="m">8</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w">   </span>total<span class="w"> </span>heap<span class="w"> </span>usage:<span class="w"> </span><span class="m">11</span><span class="w"> </span>allocs,<span class="w"> </span><span class="m">10</span><span class="w"> </span>frees,<span class="w"> </span><span class="m">1</span>,061<span class="w"> </span>bytes<span class="w"> </span><span class="nv">allocated</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w"> </span>LEAK<span class="w"> </span>SUMMARY:
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w">    </span>definitely<span class="w"> </span>lost:<span class="w"> </span><span class="m">8</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w">    </span>indirectly<span class="w"> </span>lost:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w">      </span>possibly<span class="w"> </span>lost:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w">    </span>still<span class="w"> </span>reachable:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w">         </span>suppressed:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w"> </span>Rerun<span class="w"> </span>with<span class="w"> </span>--leak-check<span class="o">=</span>full<span class="w"> </span>to<span class="w"> </span>see<span class="w"> </span>details<span class="w"> </span>of<span class="w"> </span>leaked<span class="w"> </span><span class="nv">memory</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w"> </span>For<span class="w"> </span>counts<span class="w"> </span>of<span class="w"> </span>detected<span class="w"> </span>and<span class="w"> </span>suppressed<span class="w"> </span>errors,<span class="w"> </span>rerun<span class="w"> </span>with:<span class="w"> </span>-v
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w"> </span>ERROR<span class="w"> </span>SUMMARY:<span class="w"> </span><span class="m">0</span><span class="w"> </span>errors<span class="w"> </span>from<span class="w"> </span><span class="m">0</span><span class="w"> </span>contexts<span class="w"> </span><span class="o">(</span>suppressed:<span class="w"> </span><span class="m">0</span><span class="w"> </span>from<span class="w"> </span><span class="m">0</span><span class="o">)</span>
</code></pre></div>
<p>我们可以看到退出时还有 8 字节未释放，接着查看泄漏详情：</p>
<div class="highlight"><pre><span></span><code>valgrind<span class="w"> </span>--leak-check<span class="o">=</span>full<span class="w"> </span>./bork<span class="w"> </span><span class="nv">hello</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w"> </span>Memcheck,<span class="w"> </span>a<span class="w"> </span>memory<span class="w"> </span>error<span class="w"> </span><span class="nv">detector</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w"> </span>Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2002</span>-2017,<span class="w"> </span>and<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="err">&#39;</span>d,<span class="w"> </span>by<span class="w"> </span>…
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w"> </span>Using<span class="w"> </span>Valgrind-3.13.0<span class="w"> </span>and<span class="w"> </span>LibVEX<span class="p">;</span><span class="w"> </span>rerun<span class="w"> </span>with<span class="w"> </span>-h<span class="w"> </span><span class="k">for</span><span class="w"> </span>copyright<span class="w"> </span><span class="nv">info</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w"> </span>Command:<span class="w"> </span>./bork<span class="w"> </span><span class="nv">hello</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span>
Input<span class="w"> </span>string:<span class="w"> </span><span class="s2">&quot;hello&quot;</span>
Length<span class="w"> </span>of<span class="w"> </span>translated<span class="w"> </span>string:<span class="w"> </span><span class="m">7</span>
Translate<span class="w"> </span>to<span class="w"> </span>Bork:<span class="w"> </span><span class="s2">&quot;hefllof&quot;</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w"> </span><span class="m">8</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>blocks<span class="w"> </span>are<span class="w"> </span>definitely<span class="w"> </span>lost<span class="w"> </span><span class="k">in</span><span class="w"> </span>loss<span class="w"> </span>record<span class="w"> </span><span class="m">1</span><span class="w"> </span>of<span class="w"> </span><span class="nv">1</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w">    </span>at<span class="w"> </span>0x4C31B0F:<span class="w"> </span>malloc<span class="w"> </span><span class="o">(</span><span class="k">in</span><span class="w"> </span>/usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so<span class="o">)</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x108784:<span class="w"> </span>alloc_str<span class="w"> </span><span class="o">(</span><span class="k">in</span><span class="w"> </span>/home/cc/cs61c/fa22/staff/cs61c-tac/bork<span class="o">)</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x10884E:<span class="w"> </span>concat<span class="w"> </span><span class="o">(</span><span class="k">in</span><span class="w"> </span>/home/cc/cs61c/fa22/staff/cs61c-tac/bork<span class="o">)</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x108A30:<span class="w"> </span>main<span class="w"> </span><span class="o">(</span><span class="k">in</span><span class="w"> </span>/home/cc/cs61c/fa22/staff/cs61c-tac/bork<span class="o">)</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w"> </span>LEAK<span class="w"> </span>SUMMARY:
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w">    </span>definitely<span class="w"> </span>lost:<span class="w"> </span><span class="m">8</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w">    </span>indirectly<span class="w"> </span>lost:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w">      </span>possibly<span class="w"> </span>lost:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w">    </span>still<span class="w"> </span>reachable:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w">         </span>suppressed:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w"> </span>For<span class="w"> </span>counts<span class="w"> </span>of<span class="w"> </span>detected<span class="w"> </span>and<span class="w"> </span>suppressed<span class="w"> </span>errors,<span class="w"> </span>rerun<span class="w"> </span>with:<span class="w"> </span>-v
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w"> </span>ERROR<span class="w"> </span>SUMMARY:<span class="w"> </span><span class="m">1</span><span class="w"> </span>errors<span class="w"> </span>from<span class="w"> </span><span class="m">1</span><span class="w"> </span>contexts<span class="w"> </span><span class="o">(</span>suppressed:<span class="w"> </span><span class="m">0</span><span class="w"> </span>from<span class="w"> </span><span class="m">0</span><span class="o">)</span>
</code></pre></div>
<p>这里 valgrind 告诉我们泄漏是由 <code>concat</code> 调用 <code>alloc_str</code> 时分配的。查看 <code>main</code>，我们发现为 <code>dest_str</code> 分配后并未释放。我们需要在 <code>main</code> 返回前调用 <code>free_Str</code> 释放它：</p>
<div class="highlight"><pre><span></span><code>76a77
<span class="gi">&gt;     free_Str(dest_str);</span>
</code></pre></div>
<p>（<code>src_str</code> 不用释放，因为它指向 <code>argv[1]</code>，由程序调用者管理）</p>
<p>修复后，再次运行 valgrind，确认没有泄漏：</p>
<div class="highlight"><pre><span></span><code>valgrind<span class="w"> </span>./bork<span class="w"> </span><span class="nv">hello</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span><span class="w"> </span>Memcheck,<span class="w"> </span>a<span class="w"> </span>memory<span class="w"> </span>error<span class="w"> </span><span class="nv">detector</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span><span class="w"> </span>Copyright<span class="w"> </span>…
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span><span class="w"> </span>Using<span class="w"> </span>Valgrind-3.13.0<span class="w"> </span>and<span class="w"> </span>LibVEX<span class="p">;</span><span class="w"> </span>rerun<span class="w"> </span>with<span class="w"> </span>-h<span class="w"> </span><span class="k">for</span><span class="w"> </span>copyright<span class="w"> </span><span class="nv">info</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span><span class="w"> </span>Command:<span class="w"> </span>./bork<span class="w"> </span><span class="nv">hello</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span>
Input<span class="w"> </span>string:<span class="w"> </span><span class="s2">&quot;hello&quot;</span>
Length<span class="w"> </span>of<span class="w"> </span>translated<span class="w"> </span>string:<span class="w"> </span><span class="m">7</span>
Translate<span class="w"> </span>to<span class="w"> </span>Bork:<span class="w"> </span><span class="s2">&quot;hefllof&quot;</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span><span class="w"> </span>HEAP<span class="w"> </span>SUMMARY:
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span><span class="w">     </span><span class="k">in</span><span class="w"> </span>use<span class="w"> </span>at<span class="w"> </span>exit:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span><span class="w">   </span>total<span class="w"> </span>heap<span class="w"> </span>usage:<span class="w"> </span><span class="m">11</span><span class="w"> </span>allocs,<span class="w"> </span><span class="m">11</span><span class="w"> </span>frees,<span class="w"> </span><span class="m">1</span>,061<span class="w"> </span>bytes<span class="w"> </span><span class="nv">allocated</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span><span class="w"> </span>All<span class="w"> </span>heap<span class="w"> </span>blocks<span class="w"> </span>were<span class="w"> </span>freed<span class="w"> </span>--<span class="w"> </span>no<span class="w"> </span>leaks<span class="w"> </span>are<span class="w"> </span><span class="nv">possible</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span><span class="w"> </span>For<span class="w"> </span>counts<span class="w"> </span>of<span class="w"> </span>detected<span class="w"> </span>and<span class="w"> </span>suppressed<span class="w"> </span>errors,<span class="w"> </span>rerun<span class="w"> </span>with:<span class="w"> </span>-v
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span><span class="w"> </span>ERROR<span class="w"> </span>SUMMARY:<span class="w"> </span><span class="m">0</span><span class="w"> </span>errors<span class="w"> </span>from<span class="w"> </span><span class="m">0</span><span class="w"> </span>contexts<span class="w"> </span><span class="o">(</span>suppressed:<span class="w"> </span><span class="m">0</span><span class="w"> </span>from<span class="w"> </span><span class="m">0</span><span class="o">)</span>
</code></pre></div>
<p>回到调试：在解析大量错误日志时，一个好的经验法则是只考虑第一个错误信息（忽略其余的），所以让我们这样做：</p>
<div class="highlight"><pre><span></span><code>==10170== Invalid read of size 1
==10170==    at 0x4C34D04: strlen (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==10170==    by 0x10879F: make_Str (bork.c:22)
==10170==    by 0x108978: translate_to_bork (bork.c:56)
==10170==    by 0x1089F2: main (bork.c:68)
</code></pre></div>
<p>错误信息表明我们正在进行大小为 1 的非法读取。这是什么意思？“非法读取”意味着你的程序正在读取它不应该读取的内存（这可能导致段错误，但不一定）。“大小为 1”表示我们尝试读取 1 个字节。</p>
<p>因为我们对这个古老的代码库不熟悉，并且不想为了找错误而读完整个代码，我们应该遵循一个良好的流程，从高层细节开始，逐步深入（也就是按照 valgrind 提供的调用栈逐步排查）。</p>
<p>让我们看看 bork.c 的第 68 行 main 函数（调用栈的底部）：</p>
<div class="highlight"><pre><span></span><code><span class="n">Str</span><span class="w"> </span><span class="n">bork_substr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">translate_to_bork</span><span class="p">(</span><span class="n">src_str</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</code></pre></div>
<p>这里有什么奇怪的地方吗？看起来我们只是将一个字符传给 translate_to_bork。到目前为止似乎正常。</p>
<p>让我们深入调用栈，看看第 56 行的 translate_to_bork：</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span><span class="w"> </span><span class="n">make_Str</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
</code></pre></div>
<p>这里只是调用了 make_Str。我们继续深入。看看 bork.c 第 22 行。</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">Str</span><span class="p">){.</span><span class="n">data</span><span class="o">=</span><span class="n">str</span><span class="p">,.</span><span class="n">len</span><span class="o">=</span><span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">)};</span>
</code></pre></div>
<p>这里我们创建了一个新的 Str 结构体，并设置了它的 data 和 len 参数。这也看起来正常！</p>
<p>可是 valgrind 说 strlen 正在进行非法读取？</p>
<p>我们确实是将一个字符串传给它，对吧？strlen 到底做什么？它通过遍历每个字符直到遇到空终止符来确定字符串长度。也许没有空终止符，所以 strlen 不断读取字符，越界到我们为字符串分配的区域之外。</p>
<p>让我们通过检查字符串的创建位置来确保它有空终止符。</p>
<p>之前，在 translate_to_bork 的第 56 行，我们看到了：</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span><span class="w"> </span><span class="n">make_Str</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
</code></pre></div>
<p>如果我们往上看两行（第 54 行），会看到我们通过调用 alloc_str 为字符串分配了空间。我们来看看这个函数。</p>
<div class="highlight"><pre><span></span><code><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">alloc_str</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">len</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p>嗯……看起来 alloc_str 只分配了 len 个字节的内存，这意味着当我们在 translate_to_bork 中向字符串写入时，没有多余空间放置空终止符！</p>
<p>让我们做如下修改以修复此问题：</p>
<div class="highlight"><pre><span></span><code>10c10,12
<span class="gd">&lt;     return malloc(len*sizeof(char));</span>
<span class="gs">---</span>
<span class="gi">&gt;     char *data = malloc((len+1)*sizeof(char));</span>
<span class="gi">&gt;     data[len] = &#39;\0&#39;;</span>
<span class="gi">&gt;     return data;</span>
</code></pre></div>
<p>让我们运行程序看看问题是否已修复</p>
<div class="highlight"><pre><span></span><code>./bork<span class="w"> </span>hello
Input<span class="w"> </span>string:<span class="w"> </span><span class="s2">&quot;hello&quot;</span>
Length<span class="w"> </span>of<span class="w"> </span>translated<span class="w"> </span>string:<span class="w"> </span><span class="m">7</span>
Translate<span class="w"> </span>to<span class="w"> </span>Bork:<span class="w"> </span><span class="s2">&quot;hefllof&quot;</span>
</code></pre></div>
<p>看起来一切正常。然而可能还有我们没有看到的隐藏错误，所以我们通过 valgrind 再检查一遍，确保没有潜在问题。</p>
<div class="highlight"><pre><span></span><code>valgrind<span class="w"> </span>./bork<span class="w"> </span><span class="nv">hello</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w"> </span>Memcheck,<span class="w"> </span>a<span class="w"> </span>memory<span class="w"> </span>error<span class="w"> </span><span class="nv">detector</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w"> </span>Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2002</span>-2017,<span class="w"> </span>and<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="err">&#39;</span>d,<span class="w"> </span>by<span class="w"> </span>Julian<span class="w"> </span>Seward<span class="w"> </span>et<span class="w"> </span>al.
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w"> </span>Using<span class="w"> </span>Valgrind-3.13.0<span class="w"> </span>and<span class="w"> </span>LibVEX<span class="p">;</span><span class="w"> </span>rerun<span class="w"> </span>with<span class="w"> </span>-h<span class="w"> </span><span class="k">for</span><span class="w"> </span>copyright<span class="w"> </span><span class="nv">info</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w"> </span>Command:<span class="w"> </span>./bork<span class="w"> </span><span class="nv">hello</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span>
Input<span class="w"> </span>string:<span class="w"> </span><span class="s2">&quot;hello&quot;</span>
Length<span class="w"> </span>of<span class="w"> </span>translated<span class="w"> </span>string:<span class="w"> </span><span class="m">7</span>
Translate<span class="w"> </span>to<span class="w"> </span>Bork:<span class="w"> </span><span class="s2">&quot;hefllof&quot;</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w"> </span>HEAP<span class="w"> </span>SUMMARY:
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w">     </span><span class="k">in</span><span class="w"> </span>use<span class="w"> </span>at<span class="w"> </span>exit:<span class="w"> </span><span class="m">8</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w">   </span>total<span class="w"> </span>heap<span class="w"> </span>usage:<span class="w"> </span><span class="m">11</span><span class="w"> </span>allocs,<span class="w"> </span><span class="m">10</span><span class="w"> </span>frees,<span class="w"> </span><span class="m">1</span>,061<span class="w"> </span>bytes<span class="w"> </span><span class="nv">allocated</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w"> </span>LEAK<span class="w"> </span>SUMMARY:
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w">    </span>definitely<span class="w"> </span>lost:<span class="w"> </span><span class="m">8</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w">    </span>indirectly<span class="w"> </span>lost:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w">      </span>possibly<span class="w"> </span>lost:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w">    </span>still<span class="w"> </span>reachable:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w">         </span>suppressed:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w"> </span>Rerun<span class="w"> </span>with<span class="w"> </span>--leak-check<span class="o">=</span>full<span class="w"> </span>to<span class="w"> </span>see<span class="w"> </span>details<span class="w"> </span>of<span class="w"> </span>leaked<span class="w"> </span><span class="nv">memory</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span>
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w"> </span>For<span class="w"> </span>counts<span class="w"> </span>of<span class="w"> </span>detected<span class="w"> </span>and<span class="w"> </span>suppressed<span class="w"> </span>errors,<span class="w"> </span>rerun<span class="w"> </span>with:<span class="w"> </span>-v
<span class="o">==</span><span class="nv">29797</span><span class="o">==</span><span class="w"> </span>ERROR<span class="w"> </span>SUMMARY:<span class="w"> </span><span class="m">0</span><span class="w"> </span>errors<span class="w"> </span>from<span class="w"> </span><span class="m">0</span><span class="w"> </span>contexts<span class="w"> </span><span class="o">(</span>suppressed:<span class="w"> </span><span class="m">0</span><span class="w"> </span>from<span class="w"> </span><span class="m">0</span><span class="o">)</span>
</code></pre></div>
<p>我们来看下面的堆摘要。它告诉我们在退出时仍有 1 个块（8 个字节）未被释放。这意味着堆上未释放的内存来自一次分配调用，大小为 8 字节。</p>
<p>接下来，我们可以看到堆摘要显示程序运行期间总共进行了 11 次分配调用和 10 次释放调用。</p>
<div class="highlight"><pre><span></span><code>==29797== HEAP SUMMARY:
==29797==     in use at exit: 8 bytes in 1 blocks
==29797==   total heap usage: 11 allocs, 10 frees, 1,061 bytes allocated
</code></pre></div>
<p>现在我们来看下面的泄漏摘要。它只是说明我们丢失了 1 个块（8 字节）的内存。</p>
<div class="highlight"><pre><span></span><code>==29797== LEAK SUMMARY:
==29797==    definitely lost: 8 bytes in 1 blocks
==29797==    indirectly lost: 0 bytes in 0 blocks
==29797==      possibly lost: 0 bytes in 0 blocks
==29797==    still reachable: 0 bytes in 0 blocks
==29797==         suppressed: 0 bytes in 0 blocks
==29797== Rerun with --leak-check=full to see details of leaked memory
</code></pre></div>
<p>它提示我们“使用 --leak-check=full 重新运行以查看泄漏内存的详细信息”，所以我们这么做。</p>
<div class="highlight"><pre><span></span><code>valgrind<span class="w"> </span>--leak-check<span class="o">=</span>full<span class="w"> </span>./bork<span class="w"> </span><span class="nv">hello</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w"> </span>Memcheck,<span class="w"> </span>a<span class="w"> </span>memory<span class="w"> </span>error<span class="w"> </span><span class="nv">detector</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w"> </span>Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2002</span>-2017,<span class="w"> </span>and<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="err">&#39;</span>d,<span class="w"> </span>by<span class="w"> </span>Julian<span class="w"> </span>Seward<span class="w"> </span>et<span class="w"> </span>al.
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w"> </span>Using<span class="w"> </span>Valgrind-3.13.0<span class="w"> </span>and<span class="w"> </span>LibVEX<span class="p">;</span><span class="w"> </span>rerun<span class="w"> </span>with<span class="w"> </span>-h<span class="w"> </span><span class="k">for</span><span class="w"> </span>copyright<span class="w"> </span><span class="nv">info</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w"> </span>Command:<span class="w"> </span>./bork<span class="w"> </span><span class="nv">hello</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span>
Input<span class="w"> </span>string:<span class="w"> </span><span class="s2">&quot;hello&quot;</span>
Length<span class="w"> </span>of<span class="w"> </span>translated<span class="w"> </span>string:<span class="w"> </span><span class="m">7</span>
Translate<span class="w"> </span>to<span class="w"> </span>Bork:<span class="w"> </span><span class="s2">&quot;hefllof&quot;</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w"> </span>HEAP<span class="w"> </span>SUMMARY:
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w">     </span><span class="k">in</span><span class="w"> </span>use<span class="w"> </span>at<span class="w"> </span>exit:<span class="w"> </span><span class="m">8</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w">   </span>total<span class="w"> </span>heap<span class="w"> </span>usage:<span class="w"> </span><span class="m">11</span><span class="w"> </span>allocs,<span class="w"> </span><span class="m">10</span><span class="w"> </span>frees,<span class="w"> </span><span class="m">1</span>,061<span class="w"> </span>bytes<span class="w"> </span><span class="nv">allocated</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w"> </span><span class="m">8</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>blocks<span class="w"> </span>are<span class="w"> </span>definitely<span class="w"> </span>lost<span class="w"> </span><span class="k">in</span><span class="w"> </span>loss<span class="w"> </span>record<span class="w"> </span><span class="m">1</span><span class="w"> </span>of<span class="w"> </span><span class="nv">1</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w">    </span>at<span class="w"> </span>0x4C31B0F:<span class="w"> </span>malloc<span class="w"> </span><span class="o">(</span><span class="k">in</span><span class="w"> </span>/usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so<span class="o">)</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x108784:<span class="w"> </span>alloc_str<span class="w"> </span><span class="o">(</span><span class="k">in</span><span class="w"> </span>/home/cc/cs61c/fa22/staff/cs61c-tac/bork<span class="o">)</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x10884E:<span class="w"> </span>concat<span class="w"> </span><span class="o">(</span><span class="k">in</span><span class="w"> </span>/home/cc/cs61c/fa22/staff/cs61c-tac/bork<span class="o">)</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w">    </span>by<span class="w"> </span>0x108A30:<span class="w"> </span>main<span class="w"> </span><span class="o">(</span><span class="k">in</span><span class="w"> </span>/home/cc/cs61c/fa22/staff/cs61c-tac/bork<span class="o">)</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w"> </span>LEAK<span class="w"> </span>SUMMARY:
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w">    </span>definitely<span class="w"> </span>lost:<span class="w"> </span><span class="m">8</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w">    </span>indirectly<span class="w"> </span>lost:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w">      </span>possibly<span class="w"> </span>lost:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w">    </span>still<span class="w"> </span>reachable:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w">         </span>suppressed:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span>
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w"> </span>For<span class="w"> </span>counts<span class="w"> </span>of<span class="w"> </span>detected<span class="w"> </span>and<span class="w"> </span>suppressed<span class="w"> </span>errors,<span class="w"> </span>rerun<span class="w"> </span>with:<span class="w"> </span>-v
<span class="o">==</span><span class="nv">32334</span><span class="o">==</span><span class="w"> </span>ERROR<span class="w"> </span>SUMMARY:<span class="w"> </span><span class="m">1</span><span class="w"> </span>errors<span class="w"> </span>from<span class="w"> </span><span class="m">1</span><span class="w"> </span>contexts<span class="w"> </span><span class="o">(</span>suppressed:<span class="w"> </span><span class="m">0</span><span class="w"> </span>from<span class="w"> </span><span class="m">0</span><span class="o">)</span>
</code></pre></div>
<p>现在 Valgrind 告诉我们未释放的内存块最初的分配位置。我们来看下面的调用栈。可以看到 malloc 被 alloc_str 调用，alloc_str 又被 main 中的 concat 调用。</p>
<div class="highlight"><pre><span></span><code>==32334== 8 bytes in 1 blocks are definitely lost in loss record 1 of 1
==32334==    at 0x4C31B0F: malloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==32334==    by 0x108784: alloc_str (in /home/cc/cs61c/fa22/staff/cs61c-tac/bork)
==32334==    by 0x10884E: concat (in /home/cc/cs61c/fa22/staff/cs61c-tac/bork)
==32334==    by 0x108A30: main (in /home/cc/cs61c/fa22/staff/cs61c-tac/bork)
</code></pre></div>
<p>在 main 中，我们为 dest_str 调用了 concat 分配了空间，但从未释放它。我们需要在程序结束前一直保留 dest_str，所以应该在 main 返回之前释放它。该结构体在 main 中是在栈上分配的（Str dest_str={};），因此不需要释放结构体本身。但结构体的数据域是在堆上分配的，因此只需要释放这部分内存。查看程序开头我们已经提供了 free_Str 函数用于释放结构体分配的资源。让我们在程序末尾调用该函数。</p>
<div class="highlight"><pre><span></span><code>76a77
<span class="gi">&gt;     free_Str(dest_str);</span>
</code></pre></div>
<p>你可能会问为什么我们不释放 src_str。看看我们在哪里构造 src_str（Str src_str = make_Str(argv[1]);），可以发现它是通过 make_Str 创建的，而 make_Str 并没有在堆上分配空间。我们用来构造 src_str 的字符串来自 argv[1]，而调用 main 的程序负责为 argv[1] 设置内存，所以我们无需担心它。</p>
<p>一旦我们修复了错误，valgrind 的输出应该如下所示。堆摘要显示退出时没有未释放的内存块，底部的错误摘要显示没有要报告的错误。</p>
<div class="highlight"><pre><span></span><code>valgrind<span class="w"> </span>./bork<span class="w"> </span><span class="nv">hello</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span><span class="w"> </span>Memcheck,<span class="w"> </span>a<span class="w"> </span>memory<span class="w"> </span>error<span class="w"> </span><span class="nv">detector</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span><span class="w"> </span>Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2002</span>-2017,<span class="w"> </span>and<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="err">&#39;</span>d,<span class="w"> </span>by<span class="w"> </span>Julian<span class="w"> </span>Seward<span class="w"> </span>et<span class="w"> </span>al.
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span><span class="w"> </span>Using<span class="w"> </span>Valgrind-3.13.0<span class="w"> </span>and<span class="w"> </span>LibVEX<span class="p">;</span><span class="w"> </span>rerun<span class="w"> </span>with<span class="w"> </span>-h<span class="w"> </span><span class="k">for</span><span class="w"> </span>copyright<span class="w"> </span><span class="nv">info</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span><span class="w"> </span>Command:<span class="w"> </span>./bork<span class="w"> </span><span class="nv">hello</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span>
Input<span class="w"> </span>string:<span class="w"> </span><span class="s2">&quot;hello&quot;</span>
Length<span class="w"> </span>of<span class="w"> </span>translated<span class="w"> </span>string:<span class="w"> </span><span class="m">7</span>
Translate<span class="w"> </span>to<span class="w"> </span>Bork:<span class="w"> </span><span class="s2">&quot;hefllof&quot;</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span><span class="w"> </span>HEAP<span class="w"> </span>SUMMARY:
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span><span class="w">     </span><span class="k">in</span><span class="w"> </span>use<span class="w"> </span>at<span class="w"> </span>exit:<span class="w"> </span><span class="m">0</span><span class="w"> </span>bytes<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">blocks</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span><span class="w">   </span>total<span class="w"> </span>heap<span class="w"> </span>usage:<span class="w"> </span><span class="m">11</span><span class="w"> </span>allocs,<span class="w"> </span><span class="m">11</span><span class="w"> </span>frees,<span class="w"> </span><span class="m">1</span>,061<span class="w"> </span>bytes<span class="w"> </span><span class="nv">allocated</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span><span class="w"> </span>All<span class="w"> </span>heap<span class="w"> </span>blocks<span class="w"> </span>were<span class="w"> </span>freed<span class="w"> </span>--<span class="w"> </span>no<span class="w"> </span>leaks<span class="w"> </span>are<span class="w"> </span><span class="nv">possible</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span>
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span><span class="w"> </span>For<span class="w"> </span>counts<span class="w"> </span>of<span class="w"> </span>detected<span class="w"> </span>and<span class="w"> </span>suppressed<span class="w"> </span>errors,<span class="w"> </span>rerun<span class="w"> </span>with:<span class="w"> </span>-v
<span class="o">==</span><span class="nv">10835</span><span class="o">==</span><span class="w"> </span>ERROR<span class="w"> </span>SUMMARY:<span class="w"> </span><span class="m">0</span><span class="w"> </span>errors<span class="w"> </span>from<span class="w"> </span><span class="m">0</span><span class="w"> </span>contexts<span class="w"> </span><span class="o">(</span>suppressed:<span class="w"> </span><span class="m">0</span><span class="w"> </span>from<span class="w"> </span><span class="m">0</span><span class="o">)</span>
</code></pre></div>
<h2 id="exercise-6-valgrind">Exercise 6: 使用 Valgrind 查找段错误<a class="headerlink" href="#exercise-6-valgrind" title="Permanent link">&para;</a></h2>
<p>上面，我们学习了如何使用 GDB 调试段错误。现在，我们将使用 Valgrind 做类似的事情。请在这个 <a href="https://docs.google.com/forms/d/e/1FAIpQLScjFrMcVPEb-l9_ILtFCYxfzp5vNTo8nmM73l0Mcf5yFAeX1g/viewform?usp=sf_link">Valgrind 测验</a> 中填写 7 个 Valgrind 内存错误输出示例，对应 7 个不同的 bug。</p>
<p>一般来说，使用 Valgrind 时，需要添加 <code>-g</code> 标志以包含调试信息（例如 <code>gcc -g -o example example.c</code>）。然后，对编译好的可执行文件运行 Valgrind（例如 <code>valgrind ./example</code>）。Exercise 6 中的 Valgrind 输出示例已在表单中提供。</p>
<p>你可以无限次重新提交测验，直到截止日期前拿到 100% 为止；测验会即时反馈对错情况。</p>
<h2 id="exercise-7">Exercise 7: 内存管理<a class="headerlink" href="#exercise-7" title="Permanent link">&para;</a></h2>
<p>此练习 <strong>可选</strong>，但其中涉及的概念对于 Project 1 及以后的内容非常重要，强烈推荐完成以积累经验。</p>
<p>本练习使用 <code>ex7_vector.h</code>、<code>ex7_test_vector.c</code> 和 <code>ex7_vector.c</code>，我们为你提供了一个实现可变长度数组的框架。此练习旨在帮助你熟悉 C 语言的 struct 和内存管理。</p>
<ol>
<li><strong>尝试解释</strong> 为什么 <code>bad_vector_new()</code> 是错误的。我们在此提供了答案，方便你核对理解。</li>
</ol>
<details style="box-sizing: border-box; margin-bottom: 1em; border: 1px solid currentcolor; border-radius: 0.25em; padding: 0.25em 0.5em;"><summary style="box-sizing: border-box; display: list-item; cursor: pointer;">bad_vector_new()</summary> 向量是在栈而不是堆上创建的。 一旦该函数运行完毕，栈中存储的所有内存都会被释放，因此当函数返回时，我们就会丢失构建的向量。 </details>

<ol>
<li><strong>填写</strong> <code>ex7_vector.c</code> 中的 <code>vector_new()</code> 和 <code>vector_delete()</code> 函数，使我们的测试代码 <code>ex7_test_vector.c</code> 能在没有任何内存管理错误的情况下运行。</li>
</ol>
<p>代码中的注释描述了各函数的预期行为。查看我们已实现的函数，就能了解数据结构的使用方式。为了保持一致，<em>假定向量中的所有元素在用户设置之前都是 0</em>（注意：<code>malloc()</code> 不会将分配的内存清零）。</p>
<ol>
<li><strong>测试</strong> 你的 <code>vector_new()</code> 和 <code>vector_delete()</code> 实现是否正确：</li>
</ol>
<div class="highlight"><pre><span></span><code>gcc<span class="w"> </span>-g<span class="w"> </span>-o<span class="w"> </span>ex7_vector<span class="w"> </span>ex7_vector.c<span class="w"> </span>ex7_test_vector.c
./ex7_vector
</code></pre></div>
<ol>
<li><strong>使用 Valgrind</strong> 测试你的实现是否存在内存管理问题：</li>
</ol>
<div class="highlight"><pre><span></span><code>valgrind<span class="w"> </span>./ex7_vector
</code></pre></div>
<p>任何被抑制的错误都可以忽略，不影响评分。</p>
<p>你也可以使用 CGDB 来调试代码。</p>
<h2 id="exercise-8">Exercise 8: 调试内存泄漏<a class="headerlink" href="#exercise-8" title="Permanent link">&para;</a></h2>
<p>Valgrind 非常擅长帮助我们发现和修复内存泄漏。当我们分配了内存却未释放时，就会发生内存泄漏。这很糟糕，因为不释放内存最终会耗尽所有可用内存。</p>
<p>在本练习中，你将使用 Valgrind 调试 <code>ex8_double_pointers.c</code>（务必先阅读上面的 Valgrind 章节）。</p>
<ol>
<li><strong>编译</strong> <code>ex8_double_pointers.c</code>（记得加 <code>-g</code> 标志，以便 Valgrind 能显示源代码行号）。</li>
<li><strong>运行</strong> Valgrind，观察程序有 4 次 allocs 和 3 次 frees。你还会看到在退出时堆上还有一个分配调用留下的 16 字节内存未被释放（Student 结构体大小为 16 字节）。</li>
<li><strong>再次运行</strong> Valgrind，加上 <code>--leak-check=full</code> 标志。此时你应该看到在 <code>main</code> 的第 31 行调用 <code>malloc</code> 时丢失了 16 个块。</li>
<li><strong>修复</strong> 内存泄漏 bug。</li>
<li><strong>重新编译并运行</strong> 程序，使用 Valgrind 检查。堆摘要应显示退出时无未释放的块，错误摘要应显示无错误。</li>
</ol>
<h2 id="exercise-9">Exercise 9: 反馈与调查问卷<a class="headerlink" href="#exercise-9" title="Permanent link">&para;</a></h2>
<p>我们每周都在改进课程——请填写 <a href="https://docs.google.com/forms/d/e/1FAIpQLSeZzOViL2ag_KCkpNXG0rt8R9-WJS-Qy2xblGP12R5IDHTwRA/viewform?usp=sf_link">这份调查问卷</a>，告诉我们你到目前为止在 CS 61C 的体验！</p>
<hr />
<h2 id="_2">提交<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>保存、提交并推送你的代码，然后在 Gradescope 上提交 <strong>Lab 2</strong> 作业。</p>
<hr />
<h2 id="gdb_1">常见的 GDB 错误<a class="headerlink" href="#gdb_1" title="Permanent link">&para;</a></h2>
<h3 id="gdb_2">GDB 跳过代码行<a class="headerlink" href="#gdb_2" title="Permanent link">&para;</a></h3>
<p>这可能是因为你的源文件比可执行文件更新。退出 GDB，用 <code>-g</code> 标志重新编译代码，然后重新启动 GDB。</p>
<h3 id="gdb_3">GDB 无法加载文件<a class="headerlink" href="#gdb_3" title="Permanent link">&para;</a></h3>
<p>你可能会看到 “not in executable format: file format not recognized” 或 “No symbol table loaded. Use the "file" command.” 的错误。</p>
<p>这表明你对源文件（<code>.c</code>）使用了 GDB，而不是对编译好的可执行文件。退出 GDB，确保你对可执行文件使用 GDB。</p>
<h3 id="_3">如何在代码窗口和控制台之间切换？<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>CGDB 使用类 vim 的导航：按下 <code>i</code> 键可从代码窗口切换到控制台，按下 <code>Esc</code> 可从控制台返回代码窗口。</p>
<p>GDB 使用 readline/emacs 风格导航：按 <code>Ctrl + X</code> 然后 <code>O</code> 可在窗口间切换。</p>
<h3 id="_4">我卡在代码窗口里了<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>按下 <code>i</code> 键，可返回控制台。</p>
<h3 id="ui">文本 UI 显示混乱<a class="headerlink" href="#ui" title="Permanent link">&para;</a></h3>
<p>按 <code>Ctrl + l</code> 刷新 GDB 文本 UI。</p>
<hr />
<h2 id="gdb_4">其他有用的 GDB 命令（推荐）<a class="headerlink" href="#gdb_4" title="Permanent link">&para;</a></h2>
<h3 id="info-locals">命令：<code>info locals</code><a class="headerlink" href="#info-locals" title="Permanent link">&para;</a></h3>
<p>打印当前栈帧中所有局部变量的值。</p>
<h3 id="commands">命令：<code>commands</code><a class="headerlink" href="#commands" title="Permanent link">&para;</a></h3>
<p>在每次到达断点时自动执行一系列命令。例如：</p>
<p>设置断点：</p>
<div class="highlight"><pre><span></span><code>b 73
</code></pre></div>
<p>输入 <code>commands</code> ，然后输入断点号：</p>
<div class="highlight"><pre><span></span><code>commands 1
</code></pre></div>
<p>输入你希望执行的命令列表，每条命令一行。命令列表结束后，输入 <code>end</code> 并回车。</p>
<div class="highlight"><pre><span></span><code>p var1
p var2
end
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>