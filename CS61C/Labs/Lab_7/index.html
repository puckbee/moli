
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://puckbee.github.io/moli/CS61C/Labs/Lab_7/">
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>实验 7：并行 - MOLI：提升实践能力的试炼之地</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#7" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="MOLI：提升实践能力的试炼之地" class="md-header__button md-logo" aria-label="MOLI：提升实践能力的试炼之地" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MOLI：提升实践能力的试炼之地
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              实验 7：并行
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/puckbee/moli" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    MOLI
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  首页

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../LearnPath/LearnPath/" class="md-tabs__link">
        
  
  
    
  
  学习路线

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../CS61C/" class="md-tabs__link">
          
  
  
  基础动手

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../MIT6.S081/MIT6.S081/" class="md-tabs__link">
          
  
  
  操作系统

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../AboutMOLI/" class="md-tabs__link">
          
  
  
  关于 MOLI

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="MOLI：提升实践能力的试炼之地" class="md-nav__button md-logo" aria-label="MOLI：提升实践能力的试炼之地" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    MOLI：提升实践能力的试炼之地
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/puckbee/moli" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    MOLI
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    首页
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../LearnPath/LearnPath/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    学习路线
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    基础动手
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            基础动手
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    CS61C
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            CS61C
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CS61C/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    课程简介
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Schedule/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    讲义
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    操作系统
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            操作系统
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../MIT6.S081/MIT6.S081/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MIT6.S081
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PA/PA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    南京大学 ICS
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    关于 MOLI
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            关于 MOLI
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../AboutMOLI/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    关于 MOLI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CONTRIBUTING/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    贡献说明
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="7">实验 7：并行<a class="headerlink" href="#7" title="Permanent link">&para;</a></h1>
<p><a href="https://web.archive.org/web/20241219154537/https://docs.google.com/presentation/d/1a5IOvSyLCZtPt7FOZ5bcx0e7s42Dt9nR9nvhAzMU2sA/edit?usp=sharing">实验PPT</a></p>
<h2 id="_1">环境设置<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p><strong>你必须在Hive机器上完成（本实验而非本地机器）</strong>。如需重新配置Hive机器环境，<strong>请参考Lab 0的说明</strong>。<strong>本次实验需使用Hive机器组</strong>：<code>hive1-hive30</code>（替代<code>s275</code>、<code>s277</code>等旧机器）。</p>
</div>
<p>在 hive 机器的<code>labs</code>目录中，拉取你在过去实验中可能做过的更改：</p>
<pre class="highlight"><code class="language-bash">git pull origin main</code></pre>
<p>仍然在 hive 机器的<code>labs</code>目录中，拉取本实验的文件：</p>
<pre class="highlight"><code class="language-bash">git pull starter main</code></pre>
<p>如果遇到任何<code>git</code>错误，请查看<a href="https://web.archive.org/web/20241219154537/https://cs61c.org/fa24/resources/common-errors/">常见错误</a>页面。</p>
<h2 id="_2">概述<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>在本课程中，我们涵盖三种主要的并行性类型：</p>
<ul>
<li>数据级并行性（SIMD）</li>
<li>线程级并行性（OpenMP）</li>
<li>进程级并行性（Open MPI）</li>
</ul>
<p>本实验将涉及数据级并行性（DLP）和线程级并行性（TLP）。你将在作业和项目中接触到其他形式的并行性。</p>
<h2 id="simd">SIMD<a class="headerlink" href="#simd" title="Permanent link">&para;</a></h2>
<p>阅读<a href="https://web.archive.org/web/20241219154537/https://www.intel.com/content/www/us/en/docs/intrinsics-guide/index.html">Intel Intrinsics Guide</a>以了解可用的 SIMD 指令（内部函数是一种其实现由编译器处理的函数）。<a href="https://web.archive.org/web/20241219154537/https://software.intel.com/content/www/us/en/develop/documentation/cpp-compiler-developer-guide-and-reference/top/compiler-reference/intrinsics/naming-and-usage-syntax.html">Intrinsics Naming and Usage documentation</a>将有助于理解该文档。</p>
<p>hive 机器支持 SSE、SSE2、SSE3、SSSE3、SSE4.1、SSE4.2、AVX 和 AVX2，因此你可以在过滤器列表中勾选这些选项。其他一些指令集也受支持，但在本实验中我们可以忽略它们。</p>
<p>虽然本节没有需要提交的内容，但阅读文档对本实验的其他练习和项目 4 非常有用。</p>
<hr />
<h2 id="_3">示例：循环展开<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p><code>ex1.c</code>中的<code>sum()</code>函数是一个未优化的实现，用于对大型数组（约<code>2^16</code>个元素）中值大于等于<code>128</code>的元素求和。我们使用一个外层循环重复求和<code>OUTER_ITERATIONS</code>（约<code>2^14</code>）次，以便我们可以进行更准确的运行时间测量来计算加速比。我们通过计算开始和结束时间戳（使用<code>clock()</code>）之间的差值来计时代码的执行。文件<code>ex1_test.c</code>包含一个<code>main</code>函数，用于运行各种<code>sum</code>函数并计算它们的加速比。</p>
<p>让我们看看<code>sum_unrolled()</code>。这个函数是将<code>sum</code>函数展开四次的结果。内层循环每次迭代处理 4 个元素，而<code>sum()</code>中的内层循环每次迭代处理 1 个元素。注意主循环后的额外循环 —— 由于主循环以 4 个元素为一组遍历数组，我们需要一个尾部循环来处理长度不是 4 的倍数的数组。</p>
<p>在本实验中，我们提供了<code>Makefile</code>，因此请使用提供的<code>make</code>命令而不是<code>gcc</code>来编译你的代码。尝试编译并运行代码：</p>
<pre class="highlight"><code class="language-bash">make ex1
./ex1</code></pre>
<p>展开后的函数应该会快一点，虽然不会快太多。</p>
<p>问题：如果循环展开有帮助，为什么我们不把所有循环都展开？</p>
<ul>
<li>展开后的代码更难读和写。除非你打算再也不看这段代码，否则代码的可读性可能会超过循环展开的好处！</li>
<li>有时，编译器会自动展开你写的简单循环！重点是 “有时”—— 很难弄清楚现代编译器会执行哪些神奇的操作（见下一段中的 Godbolt）。为了演示，在本实验中我们禁用了编译器优化。</li>
<li>循环展开意味着更多的指令，这意味着更大的程序和可能更差的缓存行为！</li>
<li>我们在<code>ex1.c</code>中的简化示例使用已知的数组大小。如果你不知道你正在处理的数组的大小，你展开的循环可能不适合该数组！</li>
</ul>
<p>可选：你可以通过将代码输入到这个<a href="https://web.archive.org/web/20241219154537/https://piotte13.github.io/SIMD-Visualiser/#/">链接</a>的代码环境中，来可视化向量和不同函数如何协同工作！</p>
<p>另一个可能帮助你理解 SIMD 指令行为的有趣工具是<a href="https://web.archive.org/web/20241219154537/https://godbolt.org/z/J7HXBk">Godbolt Compiler Explorer</a>项目。当你需要优化任何代码时，它也可以提供很多见解。</p>
<hr />
<h2 id="1-simd">练习 1：编写 SIMD 代码<a class="headerlink" href="#1-simd" title="Permanent link">&para;</a></h2>
<p>以下代码演示了如何使用 SIMD 指令对一个 8 元素的整数数组求和。在这个例子中，我们的寄存器是 128 位，整数是 32 位。这意味着我们可以在一个寄存器中放入 4 个整数。运行</p>
<pre class="highlight"><code class="language-c">int arr[8] = {3, 1, 4, 1, 5, 9, 2, 6};
// 初始化求和向量为{0, 0, 0, 0}
__m128i sum_vec = _mm_setzero_si128();

// 将数组元素0-3加载到临时向量寄存器
__m128i tmp = _mm_loadu_si128((__m128i *) arr);
// 添加到现有的求和向量
sum_vec = _mm_add_epi32(sum_vec, tmp);
// sum_vec = {3, 1, 4, 1}

// 将数组元素4-7加载到临时向量寄存器
tmp = _mm_loadu_si128((__m128i *) (arr + 4));
// 添加到现有的求和向量
sum_vec = _mm_add_epi32(sum_vec, tmp);
// sum_vec = {3 + 5, 1 + 9, 4 + 2, 1 + 6}

// 创建临时数组来保存sum_vec的值
// 我们必须将向量存储到数组中才能访问各个值（如下所示）
int tmp_arr[4];
_mm_storeu_si128((__m128i *) tmp_arr, sum_vec);
// 将sum_vec中的值收集到一个整数中
int sum = tmp_arr[0] + tmp_arr[1] + tmp_arr[2] + tmp_arr[3];</code></pre>
<p>对 8 个元素求和需要做很多工作。然而，这个过程极大地提高了对大型数组元素求和的性能。</p>
<ol>
<li><strong>实现</strong><code>sum_simd()</code>，一个<code>sum()</code>的向量化版本。</li>
<li><strong>复制你的</strong><code>sum_simd()</code>代码到<code>sum_simd_unrolled()</code>并将其展开4 次。不要忘记尾部情况！</li>
</ol>
<h3 id="_4">提示<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<ul>
<li>你只需要用 SIMD 对内部循环进行向量化。可以使用以下内部函数来实现：</li>
<li><code>__m128i _mm_setzero_si128()</code> - 返回一个 128 位的零向量</li>
<li><code>__m128i _mm_loadu_si128(__m128i *p)</code> - 返回存储在指针<code>p</code>处的 128 位向量</li>
<li><code>__m128i _mm_add_epi32(__m128i a, __m128i b)</code> - 返回向量<code>(a_0 + b_0, a_1 + b_1, a_2 + b_2, a_3 + b_3)</code></li>
<li><code>void _mm_storeu_si128(__m128i *p, __m128i a)</code> - 将 128 位向量 a 存储到指针<code>p</code>处</li>
<li><code>__m128i _mm_cmpgt_epi32(__m128i a, __m128i b)</code> - 返回向量<code>(a_i &gt; b_i ? 0xffffffff : 0x0 for i from 0 to 3)</code>。换句话说，如果<code>a[32*i : 32*(i+1)] &gt; b[32*i : 32*(i+1)]</code>，则<code>out[32*i : 32*(i+1)]</code>全为 1，否则全为 0。</li>
<li><code>__m128i _mm_and_si128(__m128i a, __m128i b)</code> - 返回向量<code>(a_0 &amp; b_0, a_1 &amp; b_1, a_2 &amp; b_2, a_3 &amp; b_3)</code>，其中 &amp; 表示按位与运算符</li>
<li>不要在内部循环完成之前使用存储函数（<code>_mm_storeu_si128</code>）！事实证明，存储操作的成本很高，在每次迭代中执行存储实际上会导致代码变慢。然而，如果你等到外部循环完成后再存储，可能会有溢出问题。</li>
<li>仔细阅读上面表格中的函数声明！你会注意到 loadu 和 storeu 接受<code>__m128i*</code>类型的参数。你可以将一个<code>int</code>数组转换为<code>__m128i</code>指针。</li>
</ul>
<h3 id="_5">测试<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>要编译和运行你的代码，请运行以下命令（提醒：请使用<code>make</code>，而不是<code>gcc</code>）：</p>
<pre class="highlight"><code class="language-bash">make ex1
./ex1</code></pre>
<p>在 hive 机器上， naive 版本的运行时间约为 7 秒，你的 SIMD 化版本应该在 1-2 秒内运行完。展开的 SIMD 化版本比<code>sum_simd</code>稍快，但很可能只快几分之一秒。</p>
<p>自动评分器的测试与<code>ex1_test.c</code>中的类似，但可能有不同的常量（<code>NUM_ELEMS</code>和<code>OUTER_ITERATIONS</code>）和降低的加速比要求（以补偿自动评分器资源的更多可变性）。</p>
<h3 id="_6">常见错误<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>以下是工作人员在本练习的实现中注意到的常见错误。</p>
<ul>
<li><strong>忘记尾部情况中的条件</strong>：在添加内容到求和结果之前，我们一直在检查什么条件？</li>
<li><strong>添加到未初始化的数组</strong>：如果你在没有初始化结果数组的情况下向其中添加内容，你是在向垃圾数据添加内容，这会使数组仍然是垃圾数据！</li>
<li><strong>重新初始化求和向量</strong>：确保你没有为内部循环的每次迭代创建一个新的求和向量！</li>
<li><strong>尝试将求和向量存储到<code>long long int</code>数组中</strong>：使用 int 数组。这个函数的返回值确实是<code>long long int</code>，但这是因为<code>int</code>不足以容纳所有外部循环迭代中所有值的总和。<code>long long int</code>和<code>int</code>有不同的位宽，所以将<code>int</code>数组存储到<code>long long int</code>中会产生不同的数字！</li>
</ul>
<h3 id="simd_1">一般 SIMD 建议<a class="headerlink" href="#simd_1" title="Permanent link">&para;</a></h3>
<p>关于使用 SIMD 指令的一些一般建议：</p>
<ul>
<li>注意内存对齐。例如，<code>_m256d _mm256_load_pd (double const * mem_addr)</code>不能处理未对齐的数据 —— 你需要<code>_m256d _mm256_loadu_pd</code>。同时，如果你可以控制内存分配，保持数据对齐几乎总是可取的（可以使用特殊的内存分配 API 来实现）。对齐的加载可以作为内存操作数折叠到其他操作中，这会稍微减少代码大小和吞吐量。现代 CPU 对未对齐加载有很好的支持，但当加载跨越缓存行边界时，仍然会有显著的性能损失。</li>
<li>回想一下本学期早些时候你学到的各种 CPU 流水线冒险。数据冒险会严重影响性能。也就是说，如果你没有得到期望的性能，你可能需要检查相邻 SIMD 操作中的数据依赖关系。</li>
</ul>
<h2 id="openmp">OpenMP<a class="headerlink" href="#openmp" title="Permanent link">&para;</a></h2>
<p>OpenMP 代表Open specification for Multi-Processing（开放式多处理规范）。它是一个提供 C 接口的框架。它不是 C 语言的内置部分 —— 大多数 OpenMP 特性是编译器指令。（你过去见过的一个编译器指令示例是<code>#include</code>。）</p>
<p>使用 OpenMP 进行多线程编程的好处包括：</p>
<ul>
<li>一个非常简单的接口，允许程序员将程序分为串行区域和并行区域。</li>
<li>方便的同步控制（线程中的数据竞争错误很难追踪）。</li>
</ul>
<h2 id="openmp-hello-world">示例：OpenMP Hello World<a class="headerlink" href="#openmp-hello-world" title="Permanent link">&para;</a></h2>
<p>考虑示例 hello world 程序（<code>openmp_example.c</code>），它从每个线程打印<code>"hello world from thread #"</code>：</p>
<pre class="highlight"><code class="language-c">int main() {
    #pragma omp parallel
    {
        int thread_id = omp_get_thread_num();
        printf("hello world from thread %d\n", thread_id);
    }
}</code></pre>
<p>这个程序将创建一组并行线程。每个线程打印一个 hello world 消息，以及它自己的线程编号。</p>
<p>让我们分解<code>#pragma omp parallel</code>行：</p>
<ul>
<li><code>#pragma</code>告诉编译器，该行的其余部分是一个指令。</li>
<li><code>omp</code>声明该指令是针对 OpenMP 的。</li>
<li><code>parallel</code>表示下面的块语句 —— 大括号（<code>{</code>/<code>}</code>）内的部分 —— 应该由不同的线程并行执行。</li>
</ul>
<p><strong>重要在编写你自己的代码时</strong>，确保将左大括号放在新的一行。不要把它和指令放在同一行。</p>
<p>你可以通过设置环境变量<code>OMP_NUM_THREADS</code>或在程序中的并行部分之前使用<a href="https://web.archive.org/web/20241219154537/https://gcc.gnu.org/onlinedocs/libgomp/omp_005fset_005fnum_005fthreads.html"><code>omp_set_num_threads</code></a>函数来更改 OpenMP 线程的数量。</p>
<p>尝试运行程序：</p>
<pre class="highlight"><code class="language-bash">make openmp_example
./openmp_example</code></pre>
<p>如果你多次运行<code>./openmp_example</code>，你可能会注意到打印的数字并不总是按递增顺序排列，而且很可能在不同的运行中有所不同。这是因为我们没有指定任何类型的同步选项，所以 OpenMP 不会强制执行任何执行顺序。（稍后会有更多相关内容。）同样重要的是要注意，变量<code>thread_id</code>是在并行块内部定义的，这意味着每个线程都有自己的<code>thread_id</code>副本。一般来说，在 OpenMP 中，在并行块内部声明的变量是每个线程私有的，而在并行块外部声明的变量在所有线程之间共享。有一些方法可以覆盖这一点，但稍后会详细介绍。</p>
<h2 id="openmp_1">OpenMP 指令<a class="headerlink" href="#openmp_1" title="Permanent link">&para;</a></h2>
<p>OpenMP 指令的用法可以在<a href="https://web.archive.org/web/20241219154537/https://inst.eecs.berkeley.edu/~cs61c/sp21/resources-pdfs/OpenMP3.0-SummarySpec.pdf">OpenMP 摘要卡</a>上找到。</p>
<h3 id="for">For<a class="headerlink" href="#for" title="Permanent link">&para;</a></h3>
<p>在作业 9 中，你手动将<code>for</code>循环中的迭代分配给各个线程。OpenMP 可以使用<code>for</code>指令自动处理这个问题！你可以在现有的<code>#pragma omp parallel</code>中添加<code>#pragma omp for</code>到一个<code>for</code>循环，或者单独使用<code>#pragma omp parallel for</code>。</p>
<h3 id="critical">Critical<a class="headerlink" href="#critical" title="Permanent link">&para;</a></h3>
<p>临界区中的代码在任何时候只能由单个线程执行。因此，拥有临界区自然可以防止多个线程读写相同的数据，否则会导致数据竞争。OpenMP 提供了<code>critical</code>原语，允许你在临界区中执行计算。</p>
<h3 id="reduction">Reduction<a class="headerlink" href="#reduction" title="Permanent link">&para;</a></h3>
<p>临界区可能很慢，因此 OpenMP 有一种内置的方法通过使用<code>reduction</code>关键字来减少这个问题。<code>reduction</code>关键字将通过自动减少临界区中包含的代码量来提高代码的并行性。要使用这个关键字，你必须指定应该在临界区中的变量以及对该变量执行的操作。</p>
<h2 id="2openmp">练习 2：OpenMP 点积<a class="headerlink" href="#2openmp" title="Permanent link">&para;</a></h2>
<p>乍一看，实现点积似乎与练习 1 中的<code>v_add</code>没有太大不同，因为我们现在只需要执行元素级乘法而不是加法。挑战在于如何将乘积添加到一个变量中（也就是归约）以得到我们的最终答案。如果多个线程试图同时将它们的结果添加到同一个变量中，<strong>将会导致数据竞争</strong>，这将导致不正确的结果。</p>
<p>现在尝试运行测试，只有 naive 解决方案应该通过，因为其他优化尚未实现。</p>
<pre class="highlight"><code class="language-bash">make ex2
./ex2</code></pre>
<ol>
<li>使用 OpenMP 和临界区实现<code>dotp_critical</code>。</li>
<li>注意，随着线程数量的增加，性能会变得更差吗？通过将所有归约工作放在临界区中，我们已经扁平化了并行性，使得一次只有一个线程可以做有用的工作（这与线程级并行性的理念不完全一致）。</li>
<li>这种竞争是有问题的；每个线程都在不断争夺临界区，并且在任何时候只有一个线程在取得进展。随着线程数量的增加，竞争也会增加，性能也会受到影响。</li>
<li>使用 OpenMP 和归约语句实现<code>dotp_reduction</code>。</li>
<li>提示：应该一次只能由一个线程访问的变量是<code>global_sum</code>，对它执行的操作是加法（<code>+</code>）。</li>
<li>使用 OpenMP 和归约的思想实现<code>dotp_manual_reduction</code>，但不要使用<code>reduction</code>关键字。</li>
<li>提示：为每个线程创建变量，并且仅在绝对必要时才累加到最终总和中。在你的解决方案中，你可能需要使用<code>#pragma omp critical</code>。</li>
</ol>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>